%# BEGIN BPS TAGGED BLOCK 
%# 
%# COPYRIGHT:
%# 
%# This software is Copyright (c) 1996-2008 Best Practical Solutions, LLC
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/licenses/old-licenses/gpl-2.0.html.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# END BPS TAGGED BLOCK
%#
%# Data flow here:
%#   The page receives a Query from the previous page, and maybe arguments
%#   corresponding to actions.  (If it doesn't get a Query argument, it pulls
%#   one out of the session hash.  Also, it could be getting just a raw query from
%#   Build/Edit.html (Advanced).)
%#
%#   After doing some stuff with default arguments and saved searches, the parse_query
%#   function (which is similar to, but not the same as, _parser in RT/Tickets_Overlay_SQL)
%#   converts the Query into a RT::Interface::Web::QueryBuilder::Tree.  This mason file
%#   then adds stuff to or modifies the tree based on the actions that had been requested
%#   by clicking buttons.  It then calls GetQueryAndOptionList on the tree to generate
%#   the SQL query (which is saved as a hidden input) and the option list for the Clauses
%#   box in the top right corner.
%#
%#   Worthwhile refactoring: the tree manipulation code for the actions could use some cleaning
%#   up.  The node-adding code is different in the "add" actions from in parse_query, which leads
%#   to things like parse_query correctly not quoting numbers in numerical fields, while the "add"
%#   action does quote it (this breaks SQLite).
%#
<&| /_elements/wrapper, title => _("Query Builder") &>

<form method="post" action="Build.html" name="build_query">
<input type="hidden" class="hidden" name="saved_search_id" value="<% $saved_search->{'id'} || '' %>" />
<input type="hidden" class="hidden" name="query" value="<% $current_search->{'query'} || '' %>" />
<input type="hidden" class="hidden" name="format" value="<% $current_search->{'format'} || '' %>" />
<div id="pick-criteria">
	<& Elements/PickCriteria, query => $current_search->{'query'}, queues => $queues &>
</div>
<& /Elements/Submit,  label => _('Add these terms'), name => 'add_clause'&>
<& /Elements/Submit, label => _('Add these terms and Search'), name => 'do_search'&>
<div id="editquery">
<& Elements/EditQuery,
    %ARGS,
	actions => $results,
    parsed_query => $parsed_query,
	description => $saved_search->{'description'},
    &>
</div>
<div id="editsearches">
    <& Elements/EditSearches, %$saved_search, current_search => $current_search &>
</div>
<span id="display-options">
<& Elements/DisplayOptions,
	%{Jifty->web->request->arguments},
	%$current_search,
    available_columns => $available_columns,
    current_format    => $current_format,
&>
<& /Elements/Submit, label => _('Update format and Search'), name => 'do_search', id=>"formatbuttons"&>
</span>
</form>
</&>
<%args>
$available_columns
$current_search
$saved_search
$current_format
$results
$parsed_query
$querystring
$queues
</%args>
