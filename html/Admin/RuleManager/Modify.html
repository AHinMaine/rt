%# BEGIN BPS TAGGED BLOCK {{{
%# 
%# COPYRIGHT:
%#  
%# This software is Copyright (c) 1996-2007 Best Practical Solutions, LLC 
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/copyleft/gpl.html.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# END BPS TAGGED BLOCK }}}
<& /Admin/Elements/Header, Title => $title &>
<& /Admin/Elements/RuleManagerTabs,
    id          => $RuleObj ? $RuleObj->Id : 0,
    RuleObj     => $RuleObj,
    current_tab => $current_tab,
    Title       => $title,
    Queue       => $Queue,
&>
<& /Elements/ListActions, actions => \@results &>

<form action="<%$RT::WebPath%>/Admin/RuleManager/Modify.html" method="post">
% if ($Create) {
<input type="hidden" class="hidden" name="id" value="new" />
<input type="hidden" class="hidden" name="Queue" value="<%$Queue%>" />
% } else {
<input type="hidden" class="hidden" name="id" value="<%$RuleObj->Id%>" />
<input type="hidden" class="hidden" name="Queue" value="<%$Queue%>" />
<input type="hidden" class="hidden" name="do_update" value="1" />
% }

<table>
<tr><td align="right">
<&|/l&>Rule Name</&>: 
</td>
<td><input name="Name" value="<% ($Create) ? "" : $RuleObj->Name %>" /></td>
</tr>

<tr><td align="right">
<&|/l&>Field</&>: 
</td>
<td>
<& SELF:Select,
    Name    => 'Field',
    Options => [$rm->FieldOptions],
    Default => ($Create ? '' : $RuleObj->Field),
&>
</td>
</tr>

<tr><td align="right">
<&|/l&>Match</&>: 
</td>
<td><input name="Pattern" value="<% ($Create) ? "" : $RuleObj->Pattern %>" /></td>
</tr>

<tr><td align="right">
<&|/l&>Action</&>: 
</td>
<td>
<& SELF:Select,
    Name    => 'Handler',
    Options => [$rm->HandlerOptions],
    Default => ($Create ? '' : $RuleObj->Handler),
    Refresh => 1,
&>
</td>
</tr>

% if (!$Create and $RuleObj->Handler =~ /(\w+):$/) {
%     my $default = ($Create) ? '' : $RuleObj->Argument ;
<tr><td align="right">
<&|/l&>Argument</&>: 
</td>
<td>
% if ($1 eq 'template') {
<textarea rows=10 cols=80 name="Argument"><% $default %></textarea>
% } elsif ($1 eq 'queue') {
<& /Elements/SelectQueue, Name => 'Argument', Default => $default, ShowNullOption => 1 &>
% } elsif ($1 eq 'user') {
<& /Elements/SelectOwner, Name => 'Argument', Default => $default, DefaultValue => 1, QueueObj => $QueueObj &>
% } else {
<input name="Argument" value="<% $default %>" />
% }
</td>
</tr>
% }

<tr><td align="right">
<&|/l&>After action</&>: 
</td><td>
<label style="font-weight: normal">
<input type="checkbox" name="Final" value="1" <% $Create ? '' : $RuleObj->Final ? 'checked="checked"' : '' |n %> />
<&|/l&>Stop processing the rules after this one.</&>
</label>
</tr>

</table>
<& /Elements/Submit, Label => loc('Save Changes') &>
</form>



<%INIT>
require RT::Extension::RuleManager;
my $current_tab;
my $RuleObj;
my $QueueObj;
my ($title, @results);
my $rm = RT::Extension::RuleManager->new($Queue);

if ($Queue) {
    $QueueObj = RT::Queue->new($session{'CurrentUser'});
    $QueueObj->Load($Queue);
}

$Create = 1 if not defined $id;

if ($Create) {
    $current_tab = "Admin/RuleManager/Modify.html?Queue=$Queue&Create=1";
    if ($Queue) {
        $title = loc("Create a rule for queue [_1]", $QueueObj->Name);
    }
    else {
        $title = loc("Create a rule for all queues");
    }
}
else {
    if ($id eq 'new') {
        $RuleObj = $rm->create(%ARGS);
        push @results, loc('Rule created.');
    }
    elsif ($id =~ /^\d+$/) {
        $RuleObj = $rm->load($id)
                || $rm->named($Name)
                || Abort("Couldn't load rule '$Name'");
    }
    else {
        Abort("Couldn't load rule ''");
    }

    if ($Queue) {
        $title = loc('Editing Rule #[_1] for Queue [_2]', $RuleObj->id, $QueueObj->Name);
    }
    else {
        $title = loc('Editing Global Rule #[_1]', $RuleObj->id);
    }
    
    $current_tab = "Admin/RuleManager/Queue=$Queue&Modify.html?id=".$RuleObj->id;
}

if ($RuleObj and $RuleObj->Id and $do_update) {
    $ARGS{Final} = '' unless $ARGS{Final};
    push @results, loc('Rule saved.') if $RuleObj->UpdateRecordObject(\%ARGS);
}
</%INIT>

<%METHOD Select>
<select name="<% $Name %>" <% ($Refresh ? 'onchange="this.form.submit()"' : '') |n %>>
% foreach my $val (@$Options) {
<option value="<% $val %>" <% ($Default eq $val) ? 'selected="selected"' : '' |n %>><% loc($val) %></option>
% }
</select>
<%ARGS>
$Name
$Options
$Default => ''
$Refresh => 0
</%ARGS>
</%METHOD>

<%ARGS>
$id        => undef
$result    => undef
$Name      => undef
$Create    => undef
$Queue     => 0
$do_update => 0
</%ARGS>
