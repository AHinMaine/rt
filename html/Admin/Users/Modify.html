%# BEGIN BPS TAGGED BLOCK {{{
%# 
%# COPYRIGHT:
%#  
%# This software is Copyright (c) 1996-2007 Best Practical Solutions, LLC 
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/copyleft/gpl.html.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# END BPS TAGGED BLOCK }}}
<& /Admin/Elements/Header, Title => $title  &>
<& /Admin/Elements/UserTabs, 
    id => $id, 
    user_object => $user_object,
    current_tab => $current_tab, 
    Title => $title &>

<& /Elements/ListActions, actions => \@results &>

<form action="<%RT->Config->Get('WebPath')%>/Admin/Users/Modify.html" method="post" enctype="multipart/form-data">
%if ($Create) {
<input type="hidden" class="hidden" name="id" value="new" />
% } else {
<input type="hidden" class="hidden" name="id" value="<%$user_object->id%>" />
% }
<table width="100%" border="0">
<tr>

<td valign="top" class="boxcontainer">
<&| /Widgets/TitleBox, title => loc('Identity') &>

<table>
<tr><td align="right">
<&|/l&>Username</&>:
</td><td>
<input name="name" value="<%$user_object->name%>" /> <strong><&|/l&>(required)</&></strong>
</td></tr>
<tr><td align="right">
<&|/l&>Email</&>:
</td><td>
<input name="email" value="<%$user_object->email%>" />
</td></tr>
<tr><td align="right">
<&|/l&>Real name</&>: 
</td><td>
<input name="real_name" value="<%$user_object->real_name%>" />
</td></tr>
<tr><td align="right">
<&|/l&>nickname</&>: 
</td><td>
<input name="nickname" value="<%$user_object->nickname%>" />
</td></tr>
<tr><td align="right">
<&|/l&>Unix login</&>: 
</td><td>
<input name="Gecos" value="<%$user_object->Gecos%>" />
</td></tr>
<tr><td align="right">
<&|/l&>Language</&>: 
</td><td>
<& /Elements/SelectLang, name => 'Lang', Default => $user_object->Lang &>
</td></tr>
<tr><td align="right">
<&|/l&>Extra info</&>: 
</td><td>
<textarea name="freeform_contact_info" cols="20" rows="5"><%$user_object->freeform_contact_info%></textarea>
</td></tr>
</table>
</&>
<br />
<&| /Widgets/TitleBox, title => loc('Access control') &>
<input type="hidden" class="hidden" name="SetEnabled" value="1" />
<input type="checkbox" class="checkbox" name="Enabled" value="1" <%$EnabledChecked%> />
<&|/l&>Let this user access RT</&><br />


<input type="hidden" class="hidden" name="Setprivileged" value="1" />
<input type="checkbox" class="checkbox" name="privileged" value="1" <%$privilegedChecked%> /> <&|/l&>Let this user be granted rights</&><br />
		    
% unless (RT->Config->Get('WebExternalAuth') and !RT->Config->Get('WebFallbackToInternalAuth')) {
<table>
<tr>
<td align="right">
<&|/l&>New password</&>:
</td>
<td align="left">
<input type="password" name="Pass1" autocomplete="off" />
</td>
</tr>
<tr><td align="right">
<&|/l&>Retype password</&>:
</td>
<td>
<input type="password" name="Pass2" autocomplete="off" />
</td>
</tr>
</table>
% }
</&>
</td>

<td valign="top" class="boxcontainer">
<&| /Widgets/TitleBox, title => loc('Location') &>
<table>
<tr><td align="right">
<&|/l&>organization</&>: 
</td><td>
<input name="organization" value="<%$user_object->organization%>" />
</td></tr>
<tr><td align="right">
<&|/l&>Address1</&>: 
</td><td>
<input name="Address1" value="<%$user_object->Address1%>" />
</td></tr>
<tr><td align="right">
<&|/l&>Address2</&>: 
</td><td>
<input name="Address2" value="<%$user_object->Address2%>" />
</td></tr>
<tr><td align="right">
<&|/l&>City</&>: 
</td><td>
<input name="City" value="<%$user_object->City%>" size="14" />

</td></tr>
<tr><td align="right">
<&|/l&>State</&>: 
</td><td>
<input name="State" value="<%$user_object->State%>" size="3" />

</td></tr>
<tr><td align="right">
<&|/l&>Zip</&>: 
</td><td>
<input name="Zip" value="<%$user_object->Zip%>" size="9" />
</td></tr>
<tr><td align="right">
<&|/l&>Country</&>: 
</td><td>
<input name="Country" value="<%$user_object->Country%>" />
</td></tr>
</table>
</&>
<br />
<&| /Widgets/TitleBox, title => loc('Phone numbers') &>
<table>
<tr><td align="right">
<&|/l&>Residence</&>: 
</td><td>
<input name="HomePhone" value="<%$user_object->HomePhone%>" size="13" /><br />
</td></tr>
<tr><td align="right">
<&|/l&>Work</&>: 
</td><td>
<input name="WorkPhone" value="<%$user_object->WorkPhone%>" size="13" /><br />
</td></tr>
<tr><td align="right">
<&|/l&>Mobile</&>: 
</td><td>
<input name="MobilePhone" value="<%$user_object->MobilePhone%>" size="13" /><br />
</td></tr>
<tr><td align="right">
<&|/l&>Pager</&>: 
</td><td>
<input name="PagerPhone" value="<%$user_object->PagerPhone%>" size="13" /><br />
</td>
</table>
</&>
<br />
<&| /Widgets/TitleBox, title => loc('Custom Fields') &>
<table>
% my $CFs = $user_object->CustomFields;
% while (my $CF = $CFs->next) {
<tr valign="top"><td align="right">
<% $CF->name %>:
</td><td>
% if ($user_object->id) {
<& /Elements/EditCustomField, %ARGS, Object => $user_object, CustomField => $CF &>
% } else {
<& /Elements/EditCustomField, %ARGS, namePrefix => 'Object-RT::Model::User-new-CustomField-', CustomField => $CF &>
% }
</td></tr>
% }
<tr>
</tr>
</table>
</&>
<tr>
<td colspan="2">
<&| /Widgets/TitleBox, title => loc('comments about this user') &>
<textarea class="comments" name="comments" cols="80" rows="5" wrap="virtual"><%$user_object->comments%></textarea>
</&>
%if (!$Create && $user_object->privileged) {
<br />
<&| /Widgets/TitleBox, title => loc('Signature') &>
<textarea class="signature" cols="80" rows="5" name="Signature" wrap="hard"><%$user_object->Signature%></textarea>
</&>
% }

% if ( RT->Config->Get('GnuPG')->{'Enable'} && (my $email = $user_object->email )) {
<& /Admin/Elements/ShowKeyInfo, email => $email &>
% }

</td>
</tr>
</table>

<& /Elements/Submit, Label => loc('Save Changes') &>
</form>

<%INIT>

my $current_tab;
my $user_object = RT::Model::User->new();
my ($title, $privilegedChecked, $EnabledChecked, $disabled, $result, @results);

my ($val, $msg);

if ($Create) {
    $current_tab = 'Admin/Users/Modify.html?Create=1';
    $title = loc("Create a new user");
} 
else {

    if ($id =~ /^\d+$/) { 
        $current_tab = 'Admin/Users/Modify.html?id='.$id;
    } elsif ($id eq 'new') {
	( $val, $msg ) = $user_object->create(
	    name                  => $name,
	    email          => $ARGS{'email'},
	    name                  => $ARGS{'name'},
	    comments              => $ARGS{'comments'},
	    Signature             => $ARGS{'Signature'},
	    email          => $ARGS{'email'},
	    freeform_contact_info   => $ARGS{'freeform_contact_info'},
	    organization          => $ARGS{'organization'},
	    real_name              => $ARGS{'real_name'},
	    nickname              => $ARGS{'nickname'},
	    Lang                  => $ARGS{'Lang'},
	    email_encoding         => $ARGS{'email_encoding'},
	    web_encoding           => $ARGS{'web_encoding'},
	    ExternalContactInfoId => $ARGS{'ExternalContactInfoId'},
	    ContactInfoSystem     => $ARGS{'ContactInfoSystem'},
	    Gecos                 => $ARGS{'Gecos'},
	    ExternalAuthId        => $ARGS{'ExternalAuthId'},
	    auth_system            => $ARGS{'auth_system'},
	    HomePhone             => $ARGS{'HomePhone'},
	    WorkPhone             => $ARGS{'WorkPhone'},
	    MobilePhone           => $ARGS{'MobilePhone'},
	    PagerPhone            => $ARGS{'PagerPhone'},
	    Address1              => $ARGS{'Address1'},
	    Address2              => $ARGS{'Address2'},
	    City                  => $ARGS{'City'},
	    State                 => $ARGS{'State'},
	    Zip                   => $ARGS{'Zip'},
	    Country               => $ARGS{'Country'},
	    privileged           => $ARGS{'privileged'},
	    disabled            => ($ARGS{'Enabled'} ? 0 : 1)
	);

	if ($val) {
		push @results, $msg;
        foreach my $key ( keys %ARGS) {
            # Convert custom fields on the "new" object to custom fields on the one we've just Created
            if ($key =~ /^Object-RT::Model::User-new-CustomField-(.*)$/) {
            $ARGS{'Object-RT::Model::User-'.$val.'-CustomField-'.$1} = delete $ARGS{$key};
            }
        }
        push @results, ProcessObjectCustomFieldUpdates( ARGSRef => \%ARGS, Object => $user_object );
	} else {
		push @results, loc('User could not be Created: [_1]', $msg);
	}
    } else {
	    $user_object->load($id) || $user_object->load($name) || Abort("Couldn't load user '$name'");
        $val = $user_object->id();
    }

    if ($val) {
	$title = loc("Modify the user [_1]", $user_object->name);
    }

    # If the create failed
    else {
	$title = loc("Create a new user");
	$Create = 1;
    }
}




# If we have a user to modify, lets try. 
if ($user_object->id && $id ne 'new') {

    my @fields = qw(name comments Signature email freeform_contact_info 
		    organization real_name nickname Lang email_encoding web_encoding 
		    ExternalContactInfoId ContactInfoSystem Gecos ExternalAuthId 
		    auth_system HomePhone WorkPhone MobilePhone PagerPhone Address1
		    Address2 City State Zip Country 
		   );

    my @fieldresults = UpdateRecordObject ( AttributesRef => \@fields,
					    Object => $user_object,
					    ARGSRef => \%ARGS );
    push (@results,@fieldresults);
    push @results, ProcessObjectCustomFieldUpdates( ARGSRef => \%ARGS, Object => $user_object );


    # {{{ Deal with special fields: privileged, Enabled
    if  ( $Setprivileged and $privileged != $user_object->privileged ) {
         my ($code, $msg) = $user_object->set_privileged($privileged);
         push @results, loc('privileged status: [_1]', loc_fuzzy($msg));
    }

    #we're asking about enabled on the web page but really care about disabled.
    $disabled = $Enabled ? 0 : 1;

    if  ( ($SetEnabled) and ( $disabled != $user_object->disabled) ) { 
        my  ($code, $msg) = $user_object->set_disabled($disabled);
        push @results, loc('Enabled status [_1]', loc_fuzzy($msg));
    }


    # }}}
}

if ( $user_object->id ) {
    my $password_not_set;
    # Deal with password field
    if ( !$Pass1 and !$Pass2 ) {
	$password_not_set = 1;
    } elsif ( $Pass1 ne $Pass2 ) {
	$password_not_set = 1;
        push @results, loc("passwords do not match.");
    } elsif ( $Pass1 eq $Pass2 and !$user_object->is_password($Pass1) ) {
        my ($code, $msg) = $user_object->set_password($Pass1);
        push @results, loc_fuzzy($msg);
	$password_not_set = 1 unless $code;
    }
    if ($id eq 'new' and $password_not_set) {
	push @results, loc("A password was not set, so user won't be able to login.");
    } 
}


# Do some setup for the ui
unless ( $user_object->id && $user_object->disabled ) {
    $EnabledChecked ="CHECKED";
}

if (!$Create && $user_object->privileged()) {  
    $privilegedChecked = "CHECKED";
}

# set the id, so the the menu will have the right info, this needs to
# be done here to avoid creating and then modifying a user
$id = $user_object->id;

</%INIT>


<%ARGS>
$id => undef
$name  => undef
$comments  => undef
$Signature  => undef
$email  => undef
$freeform_contact_info => undef
$organization  => undef
$real_name  => undef
$nickname  => undef
$privileged => undef
$Setprivileged => undef
$Enabled => undef
$SetEnabled => undef
$Lang  => undef
$email_encoding  => undef
$web_encoding => undef
$ExternalContactInfoId  => undef
$ContactInfoSystem  => undef
$Gecos => undef
$ExternalAuthId  => undef
$auth_system  => undef
$HomePhone => undef
$WorkPhone  => undef
$MobilePhone  => undef
$PagerPhone  => undef
$Address1 => undef
$Address2  => undef
$City  => undef
$State  => undef
$Zip  => undef
$Country => undef
$Pass1 => undef
$Pass2=> undef
$Create=> undef
</%ARGS>
