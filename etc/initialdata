# Initial data for a fresh RT3 Installation.

@Users = (
    {  name     => 'Nobody',
       real_name => 'Nobody in particular',
       comments => 'Do not delete or modify this user. It is integral '
         . 'to RT\'s internal data structures',
       privileged => '0', },

    {  name         => 'root',
       gecos        => 'root',
       real_name     => 'Enoch Root',
       password     => 'password',
       email => "root\@localhost",
       email_confirmed => 1,
       comments     => 'SuperUser',
       privileged   => '1', } );

@Groups = (
    { name        => '',
      type        => 'Everyone',                        # loc
      domain      => 'SystemInternal',
      instance    => '',
      description => 'Pseudogroup for internal use',    # loc
    },
    { type        => 'privileged',                      # loc
      domain      => 'SystemInternal',
      instance    => '',
      name        => '',
      description => 'Pseudogroup for internal use',    # loc
    },
    { name        => '',
      type        => 'Unprivileged',                    # loc
      domain      => 'SystemInternal',
      instance    => '',
      description => 'Pseudogroup for internal use',    # loc
    },
    { name        => '',
      type        => 'Owner',                               # loc
      domain      => 'RT::System-Role',
      instance    => '',
      description => 'SystemRolegroup for internal use',    # loc
    },
    { name        => '',
      type        => 'Requestor',                           # loc
      domain      => 'RT::System-Role',
      instance    => '',
      description => 'SystemRolegroup for internal use',    # loc
    },
    { name        => '',
      type        => 'Cc',                                  # loc
      domain      => 'RT::System-Role',
      instance    => '',
      description => 'SystemRolegroup for internal use',    # loc
    },
    { name        => '',
      type        => 'AdminCc',                             # loc
      domain      => 'RT::System-Role',
      instance    => '',
      description => 'Pseudogroup for internal use',        # loc
    }, );

@Queues = ({ name              => 'General',
             description       => 'The default queue',
             correspond_address => "",
             comment_address    => "", },
           { name        => '___Approvals',
             description => 'A system-internal queue for the approvals system',
             disabled    => 2, } );

@scrip_actions = (

    {  name        => 'Autoreply To Requestors',    # loc
       description =>
'Always sends a message to the requestors independent of message sender' ,                                            # loc
       exec_module => 'Autoreply',
       argument   => 'Requestor' },
    { name        => 'Notify Requestors',                    # loc
      description => 'Sends a message to the requestors',    # loc
      exec_module  => 'Notify',
      argument    => 'Requestor' },
    { name        => 'Notify Owner as comment',              # loc
      description => 'Sends mail to the owner',              # loc
      exec_module  => 'NotifyAsComment',
      argument    => 'Owner' },
    { name        => 'Notify Owner',                         # loc
      description => 'Sends mail to the owner',              # loc
      exec_module  => 'Notify',
      argument    => 'Owner' },
    { name        => 'Notify Ccs as comment',              # loc
      description => 'Sends mail to the Ccs as a comment', # loc
      exec_module  => 'NotifyAsComment',
      argument    => 'Cc' },
    { name        => 'Notify Ccs',                                   # loc
      description => 'Sends mail to the Ccs',                        # loc
      exec_module  => 'Notify',
      argument    => 'Cc' },
    { name        => 'Notify AdminCcs as comment',                        # loc
      description => 'Sends mail to the administrative Ccs as a comment', # loc
      exec_module  => 'NotifyAsComment',
      argument    => 'AdminCc' },
    { name        => 'Notify AdminCcs',                                   # loc
      description => 'Sends mail to the administrative Ccs',              # loc
      exec_module  => 'Notify',
      argument    => 'AdminCc' },

    { name        => 'Notify Requestors and Ccs as comment',              # loc
      description => 'Send mail to requestors and Ccs as a comment',      # loc
      exec_module  => 'NotifyAsComment',
      argument    => 'Requestor,Cc' },

    { name        => 'Notify Requestors and Ccs',                         # loc
      description => 'Send mail to requestors and Ccs',                   # loc
      exec_module  => 'Notify',
      argument    => 'Requestor,Cc' },

    { name        => 'Notify Requestors, Ccs and AdminCcs as comment',    # loc
      description => 'Send mail to all watchers as a "comment"',          # loc
      exec_module  => 'NotifyAsComment',
      argument    => 'All' },
    { name        => 'Notify Requestors, Ccs and AdminCcs',               # loc
      description => 'Send mail to all watchers',                         # loc
      exec_module  => 'Notify',
      argument    => 'All' },
    { name        => 'Notify Other Recipients as comment',                # loc
      description => 'Sends mail to explicitly listed Ccs and Bccs',      # loc
      exec_module  => 'NotifyAsComment',
      argument    => 'OtherRecipients' },
    { name        => 'Notify Other Recipients',                           # loc
      description => 'Sends mail to explicitly listed Ccs and Bccs',      # loc
      exec_module  => 'Notify',
      argument    => 'OtherRecipients' },
    { name        => 'User Defined',                                      # loc
      description => 'Perform a user-defined action',                     # loc
      exec_module  => 'UserDefined', },
    {  name        => 'Create Tickets',                                    # loc
       description =>
         'Create new tickets based on this scrip\'s template',             # loc
       exec_module => 'CreateTickets', },
    { name        => 'Open Tickets',                                      # loc
      description => 'Open tickets on correspondence',                    # loc
      exec_module  => 'AutoOpen' },
);

@scrip_conditions = (
    { name                 => 'On Create',                                # loc
      description          => 'When a ticket is Created',                 # loc
      applicable_trans_types => 'Create',
      exec_module           => 'AnyTransaction', },

    { name                 => 'On Transaction',                           # loc
      description          => 'When anything happens',                    # loc
      applicable_trans_types => 'Any',
      exec_module           => 'AnyTransaction', },
    {

      name                 => 'On Correspond',                             # loc
      description          => 'Whenever correspondence comes in',          # loc
      applicable_trans_types => 'Correspond',
      exec_module           => 'AnyTransaction', },

    {

      name                 => 'On comment',                                # loc
      description          => 'Whenever comments come in',                 # loc
      applicable_trans_types => 'comment',
      exec_module           => 'AnyTransaction' },
    {

      name                 => 'On Status Change',                          # loc
      description          => 'Whenever a ticket\'s status changes',       # loc
      applicable_trans_types => 'Status',
      exec_module           => 'AnyTransaction',

    },
    {

      name                 => 'On Priority Change',                       # loc
      description          => 'Whenever a ticket\'s priority changes',    # loc
      applicable_trans_types => 'Set',
      exec_module           => 'PriorityChange',
    },
    {

      name                 => 'On Owner Change',                           # loc
      description          => 'Whenever a ticket\'s owner changes',        # loc
      applicable_trans_types => 'Any',
      exec_module           => 'OwnerChange',

    },
    {

      name                 => 'On queue Change',                           # loc
      description          => 'Whenever a ticket\'s queue changes',        # loc
      applicable_trans_types => 'Set',
      exec_module           => 'QueueChange',

    },
    {  name                 => 'On Resolve',                               # loc
       description          => 'Whenever a ticket is resolved',            # loc
       applicable_trans_types => 'Status',
       exec_module           => 'StatusChange',
       argument             => 'resolved'

    },

    {  name                 => 'User Defined',                             # loc
       description          => 'Whenever a user-defined condition occurs', # loc
       applicable_trans_types => 'Any',
       exec_module           => 'UserDefined'

    },

    {  name                 => 'On Close',                                 # loc
       description          => 'Whenever a ticket is closed(inactivated)', # loc
       applicable_trans_types => 'Status,Set',
       exec_module           => 'CloseTicket',
    },
    {  name                 => 'On Reopen',                                # loc
       description          => 'Whenever a ticket is reopened(activated)', # loc
       applicable_trans_types => 'Status,Set',
       exec_module           => 'ReopenTicket',
    },

);

@Templates = (
    { queue       => '0',
      name        => 'Blank',                                             # loc
      description => 'A blank template',                                  # loc
      content     => '', },
    {  queue       => '0',
       name        => 'Autoreply',                                         # loc
       description => 'Default Autoresponse template',                     # loc
       content     => 'Subject: AutoReply: {$ticket->subject}


Greetings,

This message has been automatically generated in response to the
creation of a trouble ticket regarding:
	"{$ticket->subject()}", 
a summary of which appears below.

There is no need to reply to this message right now.  Your ticket has been
assigned an ID of [{RT->config->get(\'rtname\')} #{$ticket->id()}].

Please include the string:

         [{RT->config->get(\'rtname\')} #{$ticket->id}]

in the subject line of all future correspondence about this issue. To do so, 
you may reply to this message.

                        Thank you,
                        {$ticket->queue_obj->correspond_address()}

-------------------------------------------------------------------------
{$transaction->content()}
'
    },

    {  queue       => '0',
       name        => 'Transaction',                     # loc
       description => 'Default transaction template',    # loc
       content     => 'RT-Attach-Message: yes


{$transaction->created_as_string}: Request {$ticket->id} was acted upon.
Transaction: {$transaction->description}
       Queue: {$ticket->queue_obj->name}
     Subject: {$transaction->subject || $ticket->subject || "(No subject given)"}
       Owner: {$ticket->owner_obj->name}
  Requestors: {$ticket->requestor_addresses}
      Status: {$ticket->status}
 Ticket <URL: {RT->config->get(\'WebURL\')}/Ticket/Display.html?id={$ticket->id} >


{$transaction->content()}
'
    },

    {

      queue       => '0',
      name        => 'Admin Correspondence',                     # loc
      description => 'Default admin correspondence template',    # loc
      content     => 'RT-Attach-Message: yes


<URL: {RT->config->get(\'WebURL\')}Ticket/Display.html?id={$ticket->id} >

{$transaction->content()}
'
    },

    {  queue       => '0',
       name        => 'Correspondence',                          # loc
       description => 'Default correspondence template',         # loc
       content     => 'RT-Attach-Message: yes

{$transaction->content()}
'
    },

    {  queue       => '0',
       name        => 'Admin comment',                           # loc
       description => 'Default admin comment template',          # loc
       content     =>
'Subject: [comment] {my $s=($transaction->subject||$ticket->subject); $s =~ s/\\[comment\\]//g; $s =~ s/^Re//i; $s;}


{RT->config->get(\'WebURL\')}Ticket/Display.html?id={$ticket->id}
This is a comment.  It is not sent to the Requestor(s):

{$transaction->content()}
'
    },

    {  queue       => '0',
       name        => 'Status Change',                                     # loc
       description => 'Ticket status changed',                             # loc
       content     => 'Subject: Status Changed to: {$transaction->new_value}


{RT->config->get(\'WebURL\')}Ticket/Display.html?id={$ticket->id}

{$transaction->content()}
'
    },

    {

      queue       => '0',
      name        => 'resolved',                 # loc
      description => 'Ticket Resolved',          # loc
      content     => 'Subject: Resolved: {$ticket->subject}

According to our records, your request has been resolved. If you have any
further questions or concerns, please respond to this message.
'
    },
    {  queue       => '___Approvals',
       name        => "New Pending Approval",    # loc
       description =>
         "Notify Owners and AdminCcs of new items pending their approval", # loc
       content => 'Subject: New Pending Approval: {$ticket->subject}

Greetings,

There is a new item pending your approval: "{$ticket->subject()}", 
a summary of which appears below.

Please visit {RT->config->get(\'WebURL\')}Approvals/Display.html?id={$ticket->id}
to approve or reject this ticket, or {RT->config->get(\'WebURL\')}Approvals/ to
batch-process all your pending approvals.

-------------------------------------------------------------------------
{$transaction->content()}
'
    },
    {  queue       => '___Approvals',
       name        => "Approval Passed",    # loc
       description =>
         "Notify Owner of their ticket has been approved by some approver", # loc
       content => 'Subject: Ticket Approved: {$ticket->subject}

Greetings,

Your ticket has been approved by { eval { $Approval->owner_obj->name } }.
Other approvals may be pending.
'
    },
    {  queue       => '___Approvals',
       name        => "All Approvals Passed",    # loc
       description =>
         "Notify Owner of their ticket has been approved by all approvers", # loc
       content => 'Subject: Ticket Approved: {$ticket->subject}

Greetings,

Your ticket has been approved.  Its Owner may now start to act on it.
'
    },
    {  queue       => '___Approvals',
       name        => "Approval Rejected",    # loc
       description =>
         "Notify Owner of their rejected ticket", # loc
       content => 'Subject: Ticket Rejected: {$ticket->subject}

Greetings,

Your ticket has been rejected by { eval { $Approval->owner_obj->name } }.
'
    },
    {  queue       => 0,
       name        => "Forward",    # loc
       description => "Heading of a forwarded message", # loc
       content => q{

This is forward of transaction #{ $transaction->id } of a ticket #{ $ticket->id }
}
    },
    {  queue       => 0,
       name        => "Error: public key",    # loc
       description =>
         "Inform user that he has problems with public key and couldn't recieve encrypted content", # loc
       content => q{Subject: We have no your public key or it's wrong

You received this message as we have no your public PGP key or we have a problem with your key. Inform the administrator about the problem.
}
    },
    {  queue       => 0,
       name        => "Error to RT owner: public key",    # loc
       description =>
         "Inform RT owner that user(s) have problems with public keys", # loc
       content => q{Subject: Some users have problems with public keys

You received this message as RT has problems with public keys of the following user:
{
    foreach my $e ( @BadRecipients ) {
        $OUT .= "* ". $e->{'Message'} ."\n";
    }
}}
    },
    {  queue       => 0,
       name        => "Error: no private key",    # loc
       description =>
         "Inform user that we received an encrypted email and we have no private keys to decrypt", # loc
       content => q{Subject: we received message we cannot decrypt

You sent an encrypted message with subject '{ $Message->head->get('subject') }',
but we have no private key it's encrypted to.

Please, check that you encrypt messages with correct keys
or contact the system administrator.}
    },
    {  queue       => 0,
       name        => "Error: bad GnuPG data",    # loc
       description =>
         "Inform user that a message he sent has invalid GnuPG data", # loc
       content => q{Subject: We received a message we cannot handle

You sent us a message that we cannot handle due to corrupted GnuPG signature or encrypted block. we get the following error(s):
{ foreach my $msg ( @Messages ) {
    $OUT .= "* $msg\n";
  }
}}
    },
    {  queue       => 0,
       name        => "passwordChange",    # loc
       description =>
         "Inform user that his password has been reset", # loc
       content => q{Subject: [{RT->config->get('rtname')}] password reset

Greetings,

Someone at {$ENV{'REMOTE_ADDR'}} requested a password reset for you on {RT->config->get('WebURL')}

Your new password is:
  {$Newpassword}
}
    },
);
# }}}

@Scrips = (
    {  description    => 'On Correspond Open Tickets',
       scrip_condition => 'On Correspond',
       scrip_action    => 'Open Tickets',
       template       => 'Blank' },
    {  description    => 'On Owner Change Notify Owner',
       scrip_condition => 'On Owner Change',
       scrip_action    => 'Notify Owner',
       template       => 'Transaction' },
    {  description    => 'On Create Autoreply To Requestors',
       scrip_condition => 'On Create',
       scrip_action    => 'AutoReply To Requestors',
       template       => 'AutoReply' },
    {  description    => 'On Create Notify AdminCcs',
       scrip_condition => 'On Create',
       scrip_action    => 'Notify AdminCcs',
       template       => 'Transaction' },
    {  description    => 'On Correspond Notify AdminCcs',
       scrip_condition => 'On Correspond',
       scrip_action    => 'Notify AdminCcs',
       template       => 'Admin Correspondence' },
    {  description    => 'On Correspond Notify Requestors and Ccs',
       scrip_condition => 'On Correspond',
       scrip_action    => 'Notify Requestors And Ccs',
       template       => 'Correspondence' },
    {  description    => 'On Correspond Notify Other Recipients',
       scrip_condition => 'On Correspond',
       scrip_action    => 'Notify Other Recipients',
       template       => 'Correspondence' },
    {  description    => 'On comment Notify AdminCcs as comment',
       scrip_condition => 'On comment',
       scrip_action    => 'Notify AdminCcs As comment',
       template       => 'Admin comment' },
    {  description    => 'On comment Notify Other Recipients as comment',
       scrip_condition => 'On comment',
       scrip_action    => 'Notify Other Recipients As comment',
       template       => 'Correspondence' },
    {  description    => 'On Resolve Notify Requestors',
       scrip_condition => 'On Resolve',
       scrip_action    => 'Notify Requestors',
       template       => 'resolved' },
    {  description => "When an approval ticket is Created, notify the Owner and AdminCc of the item awaiting their approval",    # loc
       queue          => '___Approvals',
       scrip_condition => 'User Defined',
       custom_is_applicable_code => q[
	    $self->ticket_obj->type eq 'approval'	and
	    $self->transaction_obj->field eq 'Status'	and
	    $self->transaction_obj->new_value eq 'open'   and
	    eval { $T::Approving = ($self->ticket_obj->all_depended_on_by( type => 'ticket' ))[0] }
       ],
       scrip_action    => 'Notify Owner',
       template       => 'New Pending Approval' },
    {  description => "If an approval is rejected, reject the original and delete pending approvals",    # loc
       queue            => '___Approvals',
       scrip_condition   => 'On Status Change',
       scrip_action      => 'User Defined',
       custom_prepare_code => q[
# ------------------------------------------------------------------- #
return(0) unless ( lc($self->transaction_obj->new_value) eq "rejected" or
	           lc($self->transaction_obj->new_value) eq "deleted" );

my $rejected = 0;
my $links = $self->ticket_obj->depended_on_by;
foreach my $link (@{ $links->items_array_ref }) {
    my $obj = $link->base_obj;
    if ($obj->queue_obj->is_active_status($obj->status)) {
	if ($obj->type eq 'ticket') {
	    $obj->comment(
		Content	=> _("Your request was rejected."),
	    );
	    $obj->set_status(
		Status	=> 'rejected',
		Force	=> 1,
	    );

	    $T::Approval = $self->ticket_obj; # so we can access it inside templates
	    $self->{ticket_obj} = $obj;  # we want the original id in the token line
	    $rejected = 1;
	}
	else {
	    $obj->set_status(
		Status	=> 'deleted',
		Force	=> 1,
	    );
	}
    }
}

$links = $self->ticket_obj->depends_on;
foreach my $link (@{ $links->items_array_ref }) {
    my $obj = $link->target_obj;
    if ($obj->queue_obj->is_active_status($obj->status)) {
	$obj->set_status(
	    Status	=> 'deleted',
	    Force	=> 1,
	);
    }
}

# Now magically turn myself into a Requestor Notify object...
require RT::ScripAction::Notify; bless($self, 'RT::ScripAction::Notify');
$self->{argument} = 'Requestor'; $self->prepare;

return $rejected;
# ------------------------------------------------------------------- #
	],
       custom_commit_code => '"never needed"',
       template          => 'Approval Rejected', },
    {  description => "When a ticket has been approved by any approver, add correspondence to the original ticket", # loc
       queue             => '___Approvals',
       scrip_condition    => 'On Resolve',
       scrip_action       => 'User Defined',
       custom_prepare_code => q[
# ------------------------------------------------------------------- #
return(0) unless ($self->ticket_obj->type eq 'approval');

my $note;
my $t = $self->ticket_obj->transactions;
while (my $o = $t->next) {
    $note .= $o->content . "\n" if $o->content_obj
	    and $o->content !~ /Default Approval/;
}

foreach my $obj ($self->ticket_obj->all_depended_on_by( type => 'ticket' )) {
    $obj->comment(
	Content => _( "Your request has been approved by %1. Other approvals may still be pending.", # loc
	    $self->transaction_obj->creator_obj->name,
	) . "\n" . _( "Approver's notes: %1", # loc
	    $note
	),
    );
    $T::Approval = $self->ticket_obj; # so we can access it inside templates
    $self->{ticket_obj} = $obj;  # we want the original id in the token line
}

# Now magically turn myself into a Requestor Notify object...
require RT::ScripAction::Notify; bless($self, 'RT::ScripAction::Notify');
$self->{argument} = 'Requestor'; $self->prepare;

return 1;
# ------------------------------------------------------------------- #
	],
       custom_commit_code => '"never needed"',
       template => 'Approval Passed' },
    {  description => "When a ticket has been approved by all approvers, add correspondence to the original ticket", # loc
       queue             => '___Approvals',
       scrip_condition    => 'On Resolve',
       scrip_action       => 'User Defined',
       custom_prepare_code  => q[
# ------------------------------------------------------------------- #
# Find all the tickets that depend on this (that this is approving)

my $ticket = $self->ticket_obj;
my @TOP    = $ticket->all_depended_on_by( type => 'ticket' );
my $links  = $ticket->depended_on_by;
my $passed = 0;

while (my $link = $links->next) {
    my $obj = $link->base_obj;
    next if ($obj->has_unresolved_dependencies( type => 'approval' ));

    if ($obj->type eq 'ticket') {
	$obj->comment(
	    Content	=> _("Your request has been approved."),
	);
	$T::Approval  = $ticket;    # so we can access it inside templates
	$self->{ticket_obj} = $obj;  # we want the original id in the token line
	$passed = 1;
    }
    elsif ($obj->type eq 'approval') {
	$obj->set_status( Status => 'open', Force => 1 );
    }
    elsif (RT->config->get('UseCodeTickets') and $obj->type eq 'code') {
        #XXX: RT->config->get('UseCodeTickets') used only once here!!!
	my $code = $obj->transactions->first->content;
	my $rv;

	foreach my $TOP (@TOP) {
	    local $@;
	    $rv++ if eval $code;
	    Jifty->log->error("Cannot eval code: $@") if $@;
	}

	if ($rv or !@TOP) {
	    $obj->set_status( Status	=> 'resolved', Force	=> 1,);
	}
	else {
	    $obj->set_status( Status	=> 'rejected', Force	=> 1,);
	}
    }
}

# Now magically turn myself into a Requestor Notify object...
require RT::ScripAction::Notify; bless($self, 'RT::ScripAction::Notify');
$self->{argument} = 'Requestor'; $self->prepare;

return 0; # ignore $passed;
# ------------------------------------------------------------------- #
	],
       custom_commit_code => '"never needed"',
       template => 'All Approvals Passed', },

);

@ACL = (
    { user_id => 'Nobody',      # - principalId
      right  => 'OwnTicket', },

    { user_id => 'root',        # - principalid
      right  => 'SuperUser', },

);

# Predefined searches

@Attributes = (
    { name => 'Search - My Tickets',
      description => '%1 highest priority tickets I own', # loc
      content     =>
      { format =>  q{'<a href="__WebPath__/Ticket/Display.html?id=__id__">__id__</a>/TITLE:#',}
                 . q{'<a href="__WebPath__/Ticket/Display.html?id=__id__">__subject__</a>/TITLE:subject',}
                 . q{Priority, Queuename, ExtendedStatus},
        Query   => " Owner = '__CurrentUser__' AND ( Status = 'new' OR Status = 'open')",
        order_by => 'Priority',
        Order   => 'DESC'
      },
    },
    { name => 'Search - Unowned Tickets',
      description => '%1 newest unowned tickets', # loc
      content     =>
# 'Take' #loc
      { format =>  q{'<a href="__WebPath__/Ticket/Display.html?id=__id__">__id__</a>/TITLE:#',}
                 . q{'<a href="__WebPath__/Ticket/Display.html?id=__id__">__subject__</a>/TITLE:subject',}
                 . q{Queuename, ExtendedStatus, CreatedRelative, }
                 . q{'<A HREF="__WebPath__/Ticket/Display.html?Action=Take&id=__id__">___(Take)__</a>/TITLE:NBSP'},
        query   => " Owner = 'Nobody' AND ( Status = 'new' OR Status = 'open')",
        order_by => 'Created',
        order   => 'DESC'
      },
    },
    { name => 'HomepageSettings',
      description => 'HomepageSettings',
      content =>
      { 'body' => # loc
	[ { type => 'system', name => 'My Tickets' },
	  { type => 'system', name => 'Unowned Tickets' },
	  { type => 'component',  name => 'QuickCreate'},
	],
        'summary' => # loc
	[ 
	  { type => 'component', name => 'MyReminders' },
          { type => 'component', name => 'Quicksearch' },
	  { type => 'component', name => 'RefreshHomepage' },
	]
    },
}
);
