--- {{{ Attachments

CREATE TABLE Attachments (
  id INTEGER PRIMARY KEY  ,
  TransactionId INTEGER  ,
  Parent integer NULL  ,
  MessageId varchar(160) NULL  ,
  Subject varchar(255) NULL  ,
  Filename varchar(255) NULL  ,
  content_type varchar(80) NULL  ,
  ContentEncoding varchar(80) NULL  ,
  Content LONGTEXT NULL  ,
  Headers LONGTEXT NULL  ,
  Creator integer NULL  ,
  Created DATETIME NULL 
  
) ;

CREATE INDEX Attachments1 ON Attachments (Parent) ;
CREATE INDEX Attachments2 ON Attachments (TransactionId) ;
CREATE INDEX Attachments3 ON Attachments (Parent, TransactionId) ;
--- }}}

--- {{{ Queues
CREATE TABLE Queues (
  id INTEGER PRIMARY KEY  ,
  name varchar(200) NOT NULL  ,
  Description varchar(255) NULL  ,
  correspond_address varchar(120) NULL  ,
  comment_address varchar(120) NULL  ,
  initial_priority integer NULL  ,
  final_priority integer NULL  ,
  DefaultDueIn integer NULL  ,
  Creator integer NULL  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NULL  ,
  LastUpdated DATETIME NULL  ,
  disabled int2 NOT NULL DEFAULT 0 
 
) ;
CREATE UNIQUE INDEX Queues1 ON Queues (name) ;

--- }}}

--- {{{ Links

CREATE TABLE Links (
  id INTEGER PRIMARY KEY  ,
  Base varchar(240) NULL  ,
  Target varchar(240) NULL  ,
  type varchar(20) NOT NULL  ,
  LocalTarget integer NULL  ,
  LocalBase integer NULL  ,
  LastUpdatedBy integer NULL  ,
  LastUpdated DATETIME NULL  ,
  Creator integer NULL  ,
  Created DATETIME NULL  
  
) ;
CREATE UNIQUE INDEX Links1 ON Links (Base, Target, Type) ;
CREATE INDEX Links4 ON Links(Type,LocalBase);

--- }}}

--- {{{ Principals

CREATE TABLE Principals (
        id INTEGER PRIMARY KEY,
        principal_type VARCHAR(16) not null,
        object_id integer,
        disabled int2 NOT NULL DEFAULT 0 
        
) ;

--- }}}

--- {{{ Groups

CREATE TABLE Groups (
  id INTEGER ,
  name varchar(200) NULL  ,
  Description varchar(255) NULL  ,
  domain varchar(64),
  type varchar(64),
  instance integer
  
) ;

CREATE UNIQUE INDEX Groups1 ON Groups (name,domain,Type,instance) ;

--- }}}

--- {{{ ScripConditions

CREATE TABLE ScripConditions (
  id INTEGER PRIMARY KEY  ,
  name varchar(200) NULL  ,
  Description varchar(255) NULL  ,
  ExecModule varchar(60) NULL  ,
  Argument varchar(255) NULL  ,
  ApplicableTransTypes varchar(60) NULL  ,

  Creator integer NULL  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NULL  ,
  LastUpdated DATETIME NULL  
  
) ;

--- }}}

--- {{{ Transactions
CREATE TABLE Transactions (
  id INTEGER PRIMARY KEY  ,
  object_type varchar(255) NULL  ,
  object_id integer NULL  ,
  TimeTaken integer NULL  ,
  type varchar(20) NULL  ,
  Field varchar(40) NULL  ,
  old_value varchar(255) NULL  ,
  new_value varchar(255) NULL  ,
  ReferenceType varchar(255) NULL  ,
  OldReference integer NULL  ,
  NewReference integer NULL  ,
  Data varchar(255) NULL  ,

  Creator integer NULL  ,
  Created DATETIME NULL  
  
) ;
CREATE INDEX Transactions1 ON Transactions (object_type, object_id);

--- }}}

--- {{{ Scrips 

CREATE TABLE Scrips (
  id INTEGER PRIMARY KEY  ,
  Description varchar(255),
  ScripCondition integer NULL  ,
  ScripAction integer NULL  ,
  ConditionRules text NULL  ,
  ActionRules text NULL  ,
  CustomIsApplicableCode text NULL  ,
  CustomPrepareCode text NULL  ,
  CustomCommitCode text NULL  ,
  Stage varchar(32) NULL  ,
  Queue integer NULL  ,
  Template integer NULL  ,
  Creator integer NULL  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NULL  ,
  LastUpdated DATETIME NULL  
  
) ;

--- }}}

--- {{{ ACL
CREATE TABLE ACL (
  id INTEGER PRIMARY KEY  ,
  principal_type varchar(25) NOT NULL,

  principal_id INTEGER,
  right_name varchar(25) NOT NULL  ,
  object_type varchar(25) NOT NULL  ,
  object_id INTEGER default 0,
  DelegatedBy integer NOT NULL default 0, 
  DelegatedFrom integer NOT NULL default 0
  
) ;


--- }}}

--- {{{ GroupMembers 

CREATE TABLE GroupMembers (
  id INTEGER PRIMARY KEY  ,
  GroupId integer NULL,
  MemberId integer NULL
  
) ;

--- }}}

--- {{{ CachedGroupMembers

create table CachedGroupMembers (
        id integer primary key ,
        GroupId int, 
        MemberId int, 
        Via int, 
        ImmediateParentId int,
        disabled int2 NOT NULL DEFAULT 0  # if this cached group member is a member of this group by way of a disabled
                                           # group or this group is disabled, this will be set to 1
                                           # this allows us to not find members of disabled subgroups when listing off
                                           # group members recursively.
                                           # Also, this allows us to have the ACL system elide members of disabled groups

        
) ;

--- }}}

--- {{{ Users

CREATE TABLE Users (
  id INTEGER ,
  name varchar(200) NOT NULL  ,
  password varchar(40) NULL  ,
  comments blob NULL  ,
  Signature blob NULL  ,
  email varchar(120) NULL  ,
  freeform_contact_info blob NULL  ,
  organization varchar(200) NULL  ,
  real_name varchar(120) NULL  ,
  nickname varchar(16) NULL  ,
  lang varchar(16) NULL  ,
  email_encoding varchar(16) NULL  ,
  web_encoding varchar(16) NULL  ,
  ExternalContactInfoId varchar(100) NULL  ,
  ContactInfoSystem varchar(30) NULL  ,
  ExternalAuthId varchar(100) NULL  ,
  auth_system varchar(30) NULL  ,
  Gecos varchar(16) NULL  ,
  HomePhone varchar(30) NULL  ,
  WorkPhone varchar(30) NULL  ,
  MobilePhone varchar(30) NULL  ,
  PagerPhone varchar(30) NULL  ,
  Address1 varchar(200) NULL  ,
  Address2 varchar(200) NULL  ,
  City varchar(100) NULL  ,
  State varchar(100) NULL  ,
  Zip varchar(16) NULL  ,
  Country varchar(50) NULL  ,
  Timezone char(50) NULL  ,
  PGPKey text NULL,

  Creator integer NULL  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NULL  ,
  LastUpdated DATETIME NULL  
  
) ;


CREATE UNIQUE INDEX Users1 ON Users (name) ;
CREATE INDEX Users2 ON Users (name);
CREATE INDEX Users3 ON Users (id, email);
CREATE INDEX Users4 ON Users (email);


--- }}}

--- {{{ Tickets

CREATE TABLE Tickets (
  id INTEGER PRIMARY KEY  ,
  EffectiveId integer NULL  ,
  Queue integer NULL  ,
  type varchar(16) NULL  ,
  IssueStatement integer NULL  ,
  Resolution integer NULL  ,
  Owner integer NULL  ,
  Subject varchar(200) NULL DEFAULT '[no subject]' ,
  initial_priority integer NULL  ,
  final_priority integer NULL  ,
  Priority integer NULL  ,
  time_estimated integer NULL  ,
  time_worked integer NULL  ,
  Status varchar(10) NULL  ,
  time_left integer NULL  ,
  Told DATETIME NULL  ,
  starts DATETIME NULL  ,
  Started DATETIME NULL  ,
  Due DATETIME NULL  ,
  Resolved DATETIME NULL  ,


  LastUpdatedBy integer NULL  ,
  LastUpdated DATETIME NULL  ,
  Creator integer NULL  ,
  Created DATETIME NULL  ,
  disabled int2 NOT NULL DEFAULT 0
  
) ;

CREATE INDEX Tickets1 ON Tickets (Queue, Status) ;
CREATE INDEX Tickets2 ON Tickets (Owner) ;
CREATE INDEX Tickets3 ON Tickets (EffectiveId) ;
CREATE INDEX Tickets4 ON Tickets (id, Status) ;
CREATE INDEX Tickets5 ON Tickets (id, EffectiveId) ;

--- }}}

--- {{{ ScripActions

CREATE TABLE ScripActions (
  id INTEGER PRIMARY KEY  ,
  name varchar(200) NULL  ,
  Description varchar(255) NULL  ,
  ExecModule varchar(60) NULL  ,
  Argument varchar(255) NULL  ,
  Creator integer NULL  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NULL  ,
  LastUpdated DATETIME NULL  
  
) ;

--- }}}

--- {{{ Templates

CREATE TABLE Templates (
  id INTEGER PRIMARY KEY  ,
  Queue integer NOT NULL DEFAULT 0 ,
  name varchar(200) NOT NULL  ,
  Description varchar(255) NULL  ,
  type varchar(16) NULL  ,
  Language varchar(16) NULL  ,
  TranslationOf integer NULL  ,
  Content blob NULL  ,
  LastUpdated DATETIME NULL  ,
  LastUpdatedBy integer NULL  ,
  Creator integer NULL  ,
  Created DATETIME NULL  
  
) ;

--- }}}



# {{{ Objectcustom_field_values 

CREATE TABLE Objectcustom_field_values (
  id INTEGER NOT NULL  ,
  CustomField int NOT NULL  ,
  object_type varchar(255) NOT NULL,	    # Final target of the Object
  object_id int NOT NULL  ,		    # New -- Replaces Ticket
  SortOrder integer NOT NULL DEFAULT 0  ,

  Content varchar(255) NULL  ,
  LargeContent LONGTEXT NULL,		    # New -- to hold 255+ strings
  content_type varchar(80) NULL,		    # New -- only text/* gets searched
  ContentEncoding varchar(80) NULL  ,	    # New -- for binary Content

  Creator integer NOT NULL DEFAULT 0  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NOT NULL DEFAULT 0  ,
  LastUpdated DATETIME NULL  ,
  disabled int2 NOT NULL DEFAULT 0 ,
  PRIMARY KEY (id)
) ;

CREATE INDEX Objectcustom_field_values1 ON Objectcustom_field_values (Content); 
CREATE INDEX Objectcustom_field_values2 ON Objectcustom_field_values (CustomField,object_type,object_id); 

# }}}

# {{{ CustomFields

CREATE TABLE CustomFields (
  id INTEGER NOT NULL  ,
  name varchar(200) NULL  ,
  type varchar(200) NULL  ,	# Changed -- 'Single' and 'Multiple' is moved out
  MaxValues integer,		# New -- was 'Single'(1) and 'Multiple'(0)
  Pattern varchar(65536) NULL  ,	# New -- Must validate against this
  Repeated int2 NOT NULL DEFAULT 0 , # New -- repeated table entry
  Description varchar(255) NULL  ,
  SortOrder integer NOT NULL DEFAULT 0  ,
  LookupType varchar(255) NOT NULL,

  Creator integer NOT NULL DEFAULT 0  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NOT NULL DEFAULT 0  ,
  LastUpdated DATETIME NULL  ,
  disabled int2 NOT NULL DEFAULT 0 ,
  PRIMARY KEY (id)
) ;

# }}}

# {{{ ObjectCustomFields 

CREATE TABLE ObjectCustomFields (
  id INTEGER NOT NULL  ,
  CustomField int NOT NULL  ,
  object_id integer NOT NULL,
  SortOrder integer NOT NULL DEFAULT 0  ,

  Creator integer NOT NULL DEFAULT 0  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NOT NULL DEFAULT 0  ,
  LastUpdated DATETIME NULL  ,
  PRIMARY KEY (id)
) ;

# }}}

# {{{ custom_field_values 

CREATE TABLE custom_field_values (
  id INTEGER NOT NULL  ,
  CustomField int NOT NULL  ,
  name varchar(200) NULL  ,
  Description varchar(255) NULL  ,
  SortOrder integer NOT NULL DEFAULT 0  ,

  Creator integer NOT NULL DEFAULT 0  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NOT NULL DEFAULT 0  ,
  LastUpdated DATETIME NULL  ,
  PRIMARY KEY (id)
) ;

CREATE INDEX custom_field_values1 ON custom_field_values (CustomField);
 
# }}}

--- {{{ Attributes
CREATE TABLE Attributes (
  id INTEGER PRIMARY KEY  ,
  name varchar(255) NOT NULL  ,
  Description varchar(255) NULL  ,
  Content LONGTEXT NULL  ,
  content_type varchar(16),
  object_type varchar(25) NOT NULL  ,
  object_id INTEGER default 0,
  Creator integer NULL  ,
  Created DATETIME NULL  ,
  LastUpdatedBy integer NULL  ,
  LastUpdated DATETIME NULL  
 
) ;
CREATE INDEX Attributes1 on Attributes(name);
CREATE INDEX Attributes2 on Attributes(object_type, object_id);

--- }}}

